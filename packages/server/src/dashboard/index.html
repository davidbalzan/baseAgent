<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>__BOT_NAME__ â€” Dashboard</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap');

/* â”€â”€â”€ DESIGN TOKENS â”€â”€â”€ */
:root {
  --bg-0: #0a0a0b;
  --bg-1: #111113;
  --bg-2: #19191d;
  --bg-3: #222228;
  --border: #2a2a32;
  --border-active: #3a3a45;
  --text-0: #e8e8ed;
  --text-1: #a0a0b0;
  --text-2: #666680;
  --accent: #e0ff4f;
  --accent-dim: rgba(224, 255, 79, 0.12);
  --accent-glow: rgba(224, 255, 79, 0.06);
  --red: #ff4f6a;
  --orange: #ff9f43;
  --cyan: #4ff0e0;
  --blue: #4f8fff;
  --violet: #a06fff;
  --green: #4fff8f;
  --font-mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
  --font-sans: 'DM Sans', system-ui, -apple-system, sans-serif;
  --radius: 6px;
  --ease: cubic-bezier(0.16, 1, 0.3, 1);
  --topbar-h: 52px;
  --sidebar-w: 320px;
}

/* â”€â”€â”€ RESET â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 14px; -webkit-font-smoothing: antialiased; }

body {
  font-family: var(--font-sans);
  background: var(--bg-0);
  color: var(--text-0);
  min-height: 100vh;
  overflow: hidden;
}

/* â”€â”€â”€ GRAIN OVERLAY â”€â”€â”€ */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  z-index: 9999;
  pointer-events: none;
  opacity: 0.022;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size: 128px;
}

/* â”€â”€â”€ TOPBAR â”€â”€â”€ */
.topbar {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: var(--topbar-h);
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 0 16px;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border);
  z-index: 100;
}

.topbar-brand {
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 13px;
  letter-spacing: 0.03em;
  color: var(--text-0);
  flex-shrink: 0;
}

.brand-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 6px var(--accent);
  animation: pulse 3s ease-in-out infinite;
}

@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.35} }

/* Live connection indicator */
.live-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--text-2);
  transition: background 0.3s, box-shadow 0.3s;
  flex-shrink: 0;
}
.live-dot.connected { background: var(--green); }
.live-dot.active { background: var(--green); box-shadow: 0 0 6px var(--green); animation: pulse 1.2s ease-in-out infinite; }

.topbar-sep {
  width: 1px; height: 20px;
  background: var(--border);
  flex-shrink: 0;
}

/* â”€â”€â”€ TAB NAV â”€â”€â”€ */
.tab-nav {
  display: flex;
  gap: 1px;
  background: var(--bg-2);
  border-radius: 6px;
  padding: 2px;
  flex-shrink: 0;
}

.tab-btn {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 0.04em;
  padding: 4px 12px;
  border: none;
  border-radius: 4px;
  background: transparent;
  color: var(--text-2);
  cursor: pointer;
  transition: all 0.15s var(--ease);
  white-space: nowrap;
}
.tab-btn:hover { color: var(--text-1); }
.tab-btn.active { background: var(--accent); color: var(--bg-0); font-weight: 600; }

.topbar-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 14px;
}

.topbar-stat {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-2);
}
.topbar-stat strong { color: var(--text-1); font-weight: 500; }

/* Mobile hamburger */
.menu-btn {
  display: none;
  width: 32px; height: 32px;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  color: var(--text-1);
  cursor: pointer;
  font-size: 18px;
  flex-shrink: 0;
}

/* â”€â”€â”€ LAYOUT â”€â”€â”€ */
.layout {
  display: grid;
  grid-template-columns: var(--sidebar-w) 1fr;
  height: calc(100vh - var(--topbar-h));
  margin-top: var(--topbar-h);
  overflow: hidden;
}

/* Layout visibility â€” default-hidden approach for extensibility.
   Traces tab uses sidebar + main-panel; all other tabs use full-width panels.
   Plugin tabs only need:  .layout.tab-{id} .{id}-panel { display: flex; }  */
.layout.tab-traces .sidebar { display: flex; }
.layout.tab-traces .main-panel { display: flex; }
.layout:not(.tab-traces) .sidebar { display: none; }
.layout:not(.tab-traces) .main-panel { display: none; }

/* Full-width panels: hidden by default, shown by their tab */
.live-panel, .memory-panel, .costs-panel { display: none; grid-column: 1 / -1; }
.layout.tab-live .live-panel { display: flex; }
.layout.tab-memory .memory-panel { display: flex; }
.layout.tab-costs .costs-panel { display: flex; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
.sidebar {
  flex-direction: column;
  background: var(--bg-1);
  border-right: 1px solid var(--border);
  overflow: hidden;
}

.sidebar-header {
  padding: 12px 14px 10px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.sidebar-title {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-2);
  margin-bottom: 8px;
}

.sidebar-search {
  width: 100%;
  padding: 6px 10px;
  font-family: var(--font-mono);
  font-size: 12px;
  background: var(--bg-2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-0);
  outline: none;
  transition: border-color 0.2s;
}
.sidebar-search::placeholder { color: var(--text-2); }
.sidebar-search:focus { border-color: var(--accent); }

.session-list {
  flex: 1;
  overflow-y: auto;
  padding: 6px 8px;
  scrollbar-width: thin;
  scrollbar-color: var(--bg-3) transparent;
}

/* â”€â”€â”€ SESSION CARDS â”€â”€â”€ */
.session-card {
  padding: 9px 11px;
  margin-bottom: 2px;
  border-radius: var(--radius);
  cursor: pointer;
  border: 1px solid transparent;
  transition: all 0.15s var(--ease);
}
.session-card:hover { background: var(--bg-2); border-color: var(--border); }
.session-card.active { background: var(--accent-dim); border-color: var(--accent); }
.session-card.active .session-card-id { color: var(--accent); }

.session-card-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}
.session-card-id { font-family: var(--font-mono); font-size: 11px; font-weight: 500; color: var(--text-1); }
.session-card-time { font-family: var(--font-mono); font-size: 10px; color: var(--text-2); }
.session-card-input {
  font-size: 12px;
  color: var(--text-1);
  line-height: 1.4;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
  margin-bottom: 5px;
}
.session-card-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

/* â”€â”€â”€ BADGES â”€â”€â”€ */
.badge {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 0.04em;
  padding: 2px 5px;
  border-radius: 3px;
  text-transform: uppercase;
}
.badge-completed { background: rgba(79,255,143,.1); color: var(--green); }
.badge-failed { background: rgba(255,79,106,.1); color: var(--red); }
.badge-running { background: rgba(79,143,255,.1); color: var(--blue); animation: pulse 1.5s infinite; }
.badge-timeout { background: rgba(255,159,67,.1); color: var(--orange); }
.badge-cost_limit { background: rgba(255,159,67,.1); color: var(--orange); }
.badge-pending { background: rgba(160,160,176,.1); color: var(--text-2); }

.meta-item { font-family: var(--font-mono); font-size: 10px; color: var(--text-2); }

/* â”€â”€â”€ MAIN PANEL (Trace detail) â”€â”€â”€ */
.main-panel {
  flex-direction: column;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--bg-3) transparent;
}

/* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  gap: 14px;
  color: var(--text-2);
  padding: 40px;
}
.empty-state-icon {
  width: 44px; height: 44px;
  border: 2px solid var(--border);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}
.empty-state-text { font-family: var(--font-mono); font-size: 12px; text-align: center; line-height: 1.7; }

/* â”€â”€â”€ SESSION DETAIL â”€â”€â”€ */
.detail {
  padding: 22px 26px;
  max-width: 920px;
  animation: fadeUp 0.25s var(--ease);
}

@keyframes fadeUp { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

.detail-header {
  margin-bottom: 20px;
  padding-bottom: 18px;
  border-bottom: 1px solid var(--border);
}

.detail-header-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 10px;
}

.detail-session-id {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-2);
  letter-spacing: 0.02em;
  margin-bottom: 6px;
}

.detail-input {
  font-size: 15px;
  font-weight: 500;
  line-height: 1.5;
  color: var(--text-0);
  word-break: break-word;
}

/* â”€â”€â”€ STATS ROW â”€â”€â”€ */
.stats-row {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 2px;
  margin-bottom: 20px;
}

.stat-card {
  padding: 11px 13px;
  background: var(--bg-1);
  border: 1px solid var(--border);
}
.stat-card:first-child { border-radius: var(--radius) 0 0 var(--radius); }
.stat-card:last-child { border-radius: 0 var(--radius) var(--radius) 0; }

.stat-label {
  font-family: var(--font-mono);
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-2);
  margin-bottom: 4px;
}
.stat-value { font-family: var(--font-mono); font-size: 17px; font-weight: 600; color: var(--text-0); }
.stat-value.accent { color: var(--accent); }

/* â”€â”€â”€ ITERATION NAVIGATOR â”€â”€â”€ */
.iteration-nav {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}
.iteration-nav-label {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-2);
  margin-right: 2px;
}
.iter-dot {
  width: 30px; height: 30px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 600;
  background: var(--bg-2);
  border: 1px solid var(--border);
  color: var(--text-2);
  cursor: pointer;
  transition: all 0.15s var(--ease);
  flex-shrink: 0;
}
.iter-dot:hover { background: var(--bg-3); border-color: var(--border-active); color: var(--text-1); }
.iter-dot.active { background: var(--accent); border-color: var(--accent); color: var(--bg-0); box-shadow: 0 0 10px var(--accent-dim); }
.iter-dot.iter-all { width: auto; border-radius: 14px; padding: 0 10px; font-size: 10px; letter-spacing: 0.06em; }

/* â”€â”€â”€ TRACE TIMELINE â”€â”€â”€ */
.trace-timeline { position: relative; }
.trace-timeline::before {
  content: '';
  position: absolute;
  left: 14px; top: 0; bottom: 0;
  width: 1px;
  background: linear-gradient(to bottom, var(--border), transparent);
}

.trace-event {
  position: relative;
  padding-left: 42px;
  padding-bottom: 4px;
  animation: fadeUp 0.2s var(--ease) both;
}
.trace-event-dot {
  position: absolute;
  left: 7px; top: 4px;
  width: 14px; height: 14px;
  border-radius: 50%;
  border: 2px solid var(--border);
  background: var(--bg-0);
  z-index: 2;
}

.trace-event[data-phase="session_start"] .trace-event-dot { border-color: var(--accent); background: var(--accent); }
.trace-event[data-phase="reason"] .trace-event-dot { border-color: var(--blue); background: var(--blue); }
.trace-event[data-phase="tool_call"] .trace-event-dot { border-color: var(--violet); background: var(--violet); }
.trace-event[data-phase="tool_result"] .trace-event-dot { border-color: var(--cyan); background: var(--cyan); }
.trace-event[data-phase="finish"] .trace-event-dot { border-color: var(--green); background: var(--green); }
.trace-event[data-phase="error"] .trace-event-dot { border-color: var(--red); background: var(--red); }
.trace-event[data-phase="governance"] .trace-event-dot { border-color: var(--orange); background: var(--orange); }
.trace-event[data-phase="compaction"] .trace-event-dot { border-color: var(--text-2); background: var(--text-2); }
.trace-event[data-phase="observe"] .trace-event-dot { border-color: var(--text-2); }
.trace-event[data-phase="model_fallback"] .trace-event-dot { border-color: var(--orange); background: var(--orange); }

.trace-event-card {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 13px;
  margin-bottom: 7px;
  transition: border-color 0.15s;
}
.trace-event-card:hover { border-color: var(--border-active); }

.trace-event-header {
  display: flex;
  align-items: center;
  gap: 7px;
  margin-bottom: 5px;
  flex-wrap: wrap;
}
.trace-phase { font-family: var(--font-mono); font-size: 11px; font-weight: 600; letter-spacing: 0.04em; }
.trace-event[data-phase="session_start"] .trace-phase { color: var(--accent); }
.trace-event[data-phase="reason"] .trace-phase { color: var(--blue); }
.trace-event[data-phase="tool_call"] .trace-phase { color: var(--violet); }
.trace-event[data-phase="tool_result"] .trace-phase { color: var(--cyan); }
.trace-event[data-phase="finish"] .trace-phase { color: var(--green); }
.trace-event[data-phase="error"] .trace-phase { color: var(--red); }
.trace-event[data-phase="governance"] .trace-phase { color: var(--orange); }
.trace-event[data-phase="compaction"] .trace-phase { color: var(--text-2); }
.trace-event[data-phase="observe"] .trace-phase { color: var(--text-2); }
.trace-event[data-phase="model_fallback"] .trace-phase { color: var(--orange); }

.trace-iter { font-family: var(--font-mono); font-size: 10px; color: var(--text-2); padding: 1px 5px; background: var(--bg-2); border-radius: 3px; }
.trace-time { font-family: var(--font-mono); font-size: 10px; color: var(--text-2); margin-left: auto; }
.trace-tokens { font-family: var(--font-mono); font-size: 10px; color: var(--text-2); display: flex; gap: 5px; }
.trace-tokens .tok-in { color: var(--blue); }
.trace-tokens .tok-out { color: var(--cyan); }

.trace-body {
  font-family: var(--font-mono);
  font-size: 12px;
  line-height: 1.6;
  color: var(--text-1);
  white-space: pre-wrap;
  word-break: break-word;
  max-height: 260px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--bg-3) transparent;
}
.tool-name { font-weight: 600; color: var(--violet); }
.tool-result-ok { color: var(--cyan); }
.tool-result-err { color: var(--red); }
.tool-duration { font-size: 10px; color: var(--text-2); }

/* â”€â”€â”€ OUTPUT BLOCK â”€â”€â”€ */
.output-block { margin-top: 22px; padding-top: 18px; border-top: 1px solid var(--border); }
.output-label {
  font-family: var(--font-mono); font-size: 10px; font-weight: 600;
  letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-2); margin-bottom: 9px;
}
.output-text {
  font-family: var(--font-mono); font-size: 12px; line-height: 1.7; color: var(--text-0);
  padding: 14px; background: var(--bg-1); border: 1px solid var(--border);
  border-radius: var(--radius); white-space: pre-wrap; word-break: break-word;
}

/* â”€â”€â”€ LOADING â”€â”€â”€ */
.loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
.loading-spinner {
  width: 18px; height: 18px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€â”€ CHANNEL TAG â”€â”€â”€ */
.channel-tag {
  font-family: var(--font-mono); font-size: 10px; padding: 2px 5px;
  border-radius: 3px; background: var(--bg-3); color: var(--text-2);
}
.channel-tag.ch-telegram { background: rgba(79,143,255,.12); color: var(--blue); }
.channel-tag.ch-discord { background: rgba(160,111,255,.12); color: var(--violet); }
.channel-tag.ch-slack { background: rgba(79,255,143,.12); color: var(--green); }
.channel-tag.ch-http { background: rgba(255,159,67,.12); color: var(--orange); }
.channel-tag.ch-model { background: rgba(79,240,224,.12); color: var(--cyan); }

/* â”€â”€â”€ LIVE PANEL â”€â”€â”€ */
.live-panel {
  flex-direction: column;
  overflow: hidden;
}

.live-header {
  padding: 16px 20px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 12px;
}

.live-header-title {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-2);
}

.live-header-status {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-2);
}

.live-clear-btn {
  margin-left: auto;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-2);
  background: none;
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 3px 10px;
  cursor: pointer;
  transition: all 0.15s;
}
.live-clear-btn:hover { color: var(--text-1); border-color: var(--border-active); }

.live-feed {
  flex: 1;
  overflow-y: auto;
  padding: 12px 20px;
  scrollbar-width: thin;
  scrollbar-color: var(--bg-3) transparent;
}

.live-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  gap: 12px;
  color: var(--text-2);
}

.live-empty-pulse {
  width: 36px; height: 36px;
  border-radius: 50%;
  border: 2px solid var(--border);
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}
.live-empty-pulse::after {
  content: '';
  position: absolute;
  inset: 4px;
  border-radius: 50%;
  background: var(--text-2);
  opacity: 0.3;
  animation: pulse 2s ease-in-out infinite;
}

/* Live event items */
.live-event {
  display: flex;
  gap: 10px;
  padding: 7px 0;
  border-bottom: 1px solid var(--border);
  animation: fadeUp 0.2s var(--ease);
}
.live-event:last-child { border-bottom: none; }

.live-event-time {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-2);
  flex-shrink: 0;
  padding-top: 1px;
  min-width: 80px;
}

.live-event-body { flex: 1; min-width: 0; }

.live-event-session {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-2);
  margin-bottom: 2px;
}
.live-event-session .session-link {
  color: var(--accent);
  cursor: pointer;
  text-decoration: none;
}
.live-event-session .session-link:hover { text-decoration: underline; }

.live-event-msg {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-1);
  line-height: 1.5;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.live-event-msg.phase-session_start { color: var(--accent); }
.live-event-msg.phase-reason { color: var(--blue); }
.live-event-msg.phase-tool_call { color: var(--violet); }
.live-event-msg.phase-tool_result { color: var(--cyan); }
.live-event-msg.phase-finish { color: var(--green); }
.live-event-msg.phase-error { color: var(--red); }
.live-event-msg.phase-session_completed { color: var(--text-1); }

/* â”€â”€â”€ MEMORY PANEL â”€â”€â”€ */
.memory-panel {
  flex-direction: column;
  overflow: hidden;
}

.memory-header {
  padding: 16px 20px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 12px;
}

.memory-header-title {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-2);
}

.memory-subtitle {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-2);
}

.memory-reload-btn {
  margin-left: auto;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-2);
  background: none;
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 3px 10px;
  cursor: pointer;
  transition: all 0.15s;
}
.memory-reload-btn:hover { color: var(--text-1); border-color: var(--border-active); }

.memory-grid {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
  gap: 14px;
  align-content: start;
  scrollbar-width: thin;
  scrollbar-color: var(--bg-3) transparent;
}

.memory-card {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  display: flex;
  flex-direction: column;
  min-height: 180px;
  max-height: 420px;
  overflow: hidden;
  transition: border-color 0.15s;
}
.memory-card:hover { border-color: var(--border-active); }

.memory-card-header {
  padding: 10px 13px 8px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}

.memory-card-name {
  font-family: var(--font-mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--text-0);
}

.memory-card-desc {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-2);
}

.memory-card-actions { margin-left: auto; display: flex; gap: 6px; }

.mem-btn {
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 3px 9px;
  border-radius: 3px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-2);
  cursor: pointer;
  transition: all 0.15s;
}
.mem-btn:hover { color: var(--text-1); border-color: var(--border-active); }
.mem-btn.primary { border-color: var(--accent); color: var(--accent); }
.mem-btn.primary:hover { background: var(--accent-dim); }

.memory-card-content {
  flex: 1;
  overflow-y: auto;
  padding: 10px 13px;
  font-family: var(--font-mono);
  font-size: 12px;
  line-height: 1.65;
  color: var(--text-1);
  white-space: pre-wrap;
  word-break: break-word;
  scrollbar-width: thin;
  scrollbar-color: var(--bg-3) transparent;
}
.memory-card-empty { color: var(--text-2); font-style: italic; }

.memory-card-editor {
  flex-shrink: 0;
  border-top: 1px solid var(--border);
  padding: 10px 13px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.mem-textarea {
  width: 100%;
  min-height: 100px;
  max-height: 240px;
  padding: 8px 10px;
  font-family: var(--font-mono);
  font-size: 12px;
  line-height: 1.6;
  background: var(--bg-2);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text-0);
  resize: vertical;
  outline: none;
  transition: border-color 0.2s;
}
.mem-textarea:focus { border-color: var(--accent); }

.mem-editor-actions { display: flex; gap: 6px; justify-content: flex-end; }

.mem-status {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--green);
  transition: opacity 0.5s;
}
.mem-status.hidden { opacity: 0; }

/* â”€â”€â”€ COSTS PANEL â”€â”€â”€ */
.costs-panel {
  flex-direction: column;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--bg-3) transparent;
}

.costs-content {
  padding: 20px 24px;
  max-width: 1100px;
  animation: fadeUp 0.25s var(--ease);
}

.costs-section { margin-bottom: 26px; }

.costs-section-title {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-2);
  margin-bottom: 10px;
}

.costs-stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 2px;
  margin-bottom: 26px;
}
.costs-stats-row .stat-card:first-child { border-radius: var(--radius) 0 0 var(--radius); }
.costs-stats-row .stat-card:last-child { border-radius: 0 var(--radius) var(--radius) 0; }

.daily-chart {
  display: flex;
  align-items: flex-end;
  gap: 3px;
  height: 150px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.daily-bar-wrap {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  justify-content: flex-end;
  position: relative;
}
.daily-bar {
  width: 100%;
  max-width: 22px;
  background: var(--accent);
  border-radius: 3px 3px 0 0;
  min-height: 2px;
  position: relative;
  transition: opacity 0.15s;
}
.daily-bar:hover { opacity: 0.75; }
.daily-bar-tooltip {
  display: none;
  position: absolute;
  bottom: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-3);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 4px 8px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-0);
  white-space: nowrap;
  z-index: 10;
  pointer-events: none;
}
.daily-bar:hover .daily-bar-tooltip { display: block; }
.daily-bar-date {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--text-2);
  margin-top: 5px;
  writing-mode: vertical-rl;
  text-orientation: mixed;
  transform: rotate(180deg);
  max-height: 38px;
  overflow: hidden;
}

.h-bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 7px; }
.h-bar-label { font-family: var(--font-mono); font-size: 11px; color: var(--text-1); min-width: 90px; text-align: right; }
.h-bar-track { flex: 1; height: 20px; background: var(--bg-2); border-radius: 3px; overflow: hidden; }
.h-bar-fill {
  height: 100%;
  border-radius: 3px;
  display: flex; align-items: center;
  padding: 0 7px;
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 500;
  color: var(--bg-0);
  min-width: fit-content;
  transition: width 0.4s var(--ease);
}
.h-bar-fill.accent { background: var(--accent); }
.h-bar-fill.blue { background: var(--blue); color: var(--text-0); }
.h-bar-fill.cyan { background: var(--cyan); }
.h-bar-fill.violet { background: var(--violet); color: var(--text-0); }
.h-bar-fill.green { background: var(--green); }
.h-bar-fill.orange { background: var(--orange); }
.h-bar-fill.red { background: var(--red); }
.h-bar-value { font-family: var(--font-mono); font-size: 11px; color: var(--text-2); min-width: 64px; }

.costs-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 22px; }

.top-table { width: 100%; border-collapse: collapse; }
.top-table th {
  font-family: var(--font-mono); font-size: 10px; font-weight: 600;
  letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-2);
  text-align: left; padding: 7px 9px; border-bottom: 1px solid var(--border);
}
.top-table td {
  font-family: var(--font-mono); font-size: 12px; color: var(--text-1);
  padding: 7px 9px; border-bottom: 1px solid var(--bg-2);
}
.top-table tr:hover td { background: var(--bg-2); }
.top-table .link { color: var(--accent); cursor: pointer; text-decoration: none; }
.top-table .link:hover { text-decoration: underline; }

/* __PLUGIN_CSS__ */

/* â”€â”€â”€ MOBILE â”€â”€â”€ */
@media (max-width: 700px) {
  :root { --sidebar-w: 100%; }

  .topbar { gap: 8px; padding: 0 12px; }
  .topbar-right { display: none; }
  .menu-btn { display: flex; }

  .tab-nav { display: none; }
  .tab-nav.open { display: flex; position: fixed; top: var(--topbar-h); left: 0; right: 0; background: var(--bg-1); border-bottom: 1px solid var(--border); border-radius: 0; padding: 8px 12px; z-index: 99; flex-wrap: wrap; gap: 4px; }

  .layout {
    grid-template-columns: 1fr;
  }

  /* On mobile, traces tab shows sidebar by default */
  .layout.tab-traces.detail-visible .sidebar { display: none; }
  .layout.tab-traces.detail-visible .main-panel { display: flex; }
  .layout.tab-traces:not(.detail-visible) .sidebar { display: flex; }
  .layout.tab-traces:not(.detail-visible) .main-panel { display: none; }

  .mobile-back-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px 6px;
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--accent);
    cursor: pointer;
    background: none;
    border: none;
    flex-shrink: 0;
  }

  .detail { padding: 14px 16px; }

  .stats-row {
    grid-template-columns: repeat(3, 1fr);
  }
  .stat-card:first-child { border-radius: var(--radius) 0 0 0; }
  .stat-card:nth-child(3) { border-radius: 0 var(--radius) 0 0; }
  .stat-card:nth-child(4) { border-radius: 0 0 0 var(--radius); }
  .stat-card:last-child { border-radius: 0 0 var(--radius) 0; }

  .costs-stats-row { grid-template-columns: repeat(2, 1fr); }
  .costs-stats-row .stat-card { border-radius: var(--radius) !important; }
  .costs-grid { grid-template-columns: 1fr; }
  .memory-grid { grid-template-columns: 1fr; padding: 12px 14px; }
  .live-feed { padding: 10px 14px; }
  .costs-content { padding: 14px 16px; }
}
</style>
</head>
<body>

<!-- TOP BAR -->
<header class="topbar">
  <button class="menu-btn" id="menu-btn" onclick="toggleMenu()" aria-label="Menu">â˜°</button>
  <div class="topbar-brand">
    <span class="brand-dot"></span>
    __BOT_NAME__
  </div>
  <div class="topbar-sep"></div>
  <nav class="tab-nav" id="tab-nav">
    <button class="tab-btn active" data-tab="traces" onclick="switchTab('traces')">Traces</button>
    <button class="tab-btn" data-tab="live" onclick="switchTab('live')">Live</button>
    <button class="tab-btn" data-tab="memory" onclick="switchTab('memory')">Memory</button>
    <button class="tab-btn" data-tab="costs" onclick="switchTab('costs')">Costs</button>
    <!-- __PLUGIN_TAB_BUTTONS__ -->
  </nav>
  <div class="topbar-right">
    <span class="live-dot" id="live-dot" title="Live stream disconnected"></span>
    <span class="topbar-stat" id="stat-sessions">Sessions: <strong>--</strong></span>
    <span class="topbar-stat" id="stat-uptime">Uptime: <strong>--</strong></span>
  </div>
</header>

<!-- LAYOUT -->
<div class="layout tab-traces" id="layout">

  <!-- â”€â”€ SIDEBAR (session list) â”€â”€ -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">Sessions</div>
      <input type="text" class="sidebar-search" placeholder="Filter sessionsâ€¦" id="session-search">
    </div>
    <div class="session-list" id="session-list">
      <div class="loading"><div class="loading-spinner"></div></div>
    </div>
  </aside>

  <!-- â”€â”€ MAIN PANEL (trace detail) â”€â”€ -->
  <main class="main-panel" id="main-panel">
    <div class="empty-state">
      <div class="empty-state-icon">&rang;</div>
      <div class="empty-state-text">
        Select a session to replay its trace.<br>
        <span style="color:var(--text-2)">Sessions load from the agent database.</span>
      </div>
    </div>
  </main>

  <!-- â”€â”€ LIVE PANEL â”€â”€ -->
  <section class="live-panel" id="live-panel">
    <div class="live-header">
      <div class="live-header-title">Live Feed</div>
      <span class="live-header-status" id="live-status">Connectingâ€¦</span>
      <button class="live-clear-btn" onclick="clearLiveFeed()">Clear</button>
    </div>
    <div class="live-feed" id="live-feed">
      <div class="live-empty">
        <div class="live-empty-pulse"></div>
        <div class="empty-state-text">Waiting for session activityâ€¦</div>
      </div>
    </div>
  </section>

  <!-- â”€â”€ MEMORY PANEL â”€â”€ -->
  <section class="memory-panel" id="memory-panel">
    <div class="memory-header">
      <div class="memory-header-title">Memory Files</div>
      <span class="memory-subtitle">workspace/</span>
      <button class="memory-reload-btn" onclick="loadMemory()">Reload</button>
    </div>
    <div class="memory-grid" id="memory-grid">
      <div class="loading" style="grid-column:1/-1"><div class="loading-spinner"></div></div>
    </div>
  </section>

  <!-- â”€â”€ COSTS PANEL â”€â”€ -->
  <section class="costs-panel" id="costs-panel">
    <div class="loading" style="height:200px"><div class="loading-spinner"></div></div>
  </section>

  <!-- __PLUGIN_PANELS__ -->

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let sessions = [];
let currentSessionId = null;
let currentTraces = [];
let currentIteration = null;
let currentTab = 'traces';
let costsData = null;
let memoryLoaded = false;
let liveEventSource = null;
let liveEvents = [];
let activeSessions = new Set();
const MAX_LIVE_EVENTS = 300;

const $layout = document.getElementById('layout');
const $sessionList = document.getElementById('session-list');
const $mainPanel = document.getElementById('main-panel');
const $search = document.getElementById('session-search');
const $statSessions = document.getElementById('stat-sessions');
const $statUptime = document.getElementById('stat-uptime');
const $liveDot = document.getElementById('live-dot');
const $liveStatus = document.getElementById('live-status');
const $liveFeed = document.getElementById('live-feed');
const $memoryGrid = document.getElementById('memory-grid');
const $costsPanel = document.getElementById('costs-panel');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  await loadSessions();
  loadHealth();
  setInterval(loadHealth, 30_000);
  setInterval(loadSessions, 15_000); // auto-refresh session list
  initLiveStream();

  const hash = window.location.hash.slice(1);
  if (hash) selectSession(hash);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// API HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SESSIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSessions() {
  try {
    const data = await fetchJSON('/api/sessions?limit=100');
    sessions = data.sessions;
    $statSessions.innerHTML = `Sessions: <strong>${sessions.length}</strong>`;
    renderSessionList($search.value);
  } catch {
    $sessionList.innerHTML = '<div class="empty-state-text" style="padding:20px">Failed to load sessions</div>';
  }
}

async function loadHealth() {
  try {
    const data = await fetchJSON('/health');
    const secs = data.uptime;
    const h = Math.floor(secs / 3600), m = Math.floor((secs % 3600) / 60);
    $statUptime.innerHTML = `Uptime: <strong>${h}h ${m}m</strong>`;
  } catch {}
}

function renderSessionList(filter = '') {
  const filtered = filter
    ? sessions.filter(s =>
        s.id.includes(filter) ||
        (s.input || '').toLowerCase().includes(filter.toLowerCase()) ||
        (s.channelId || '').toLowerCase().includes(filter.toLowerCase()) ||
        (s.status || '').toLowerCase().includes(filter.toLowerCase())
      )
    : sessions;

  if (filtered.length === 0) {
    $sessionList.innerHTML = '<div class="empty-state-text" style="padding:20px">No sessions found</div>';
    return;
  }

  $sessionList.innerHTML = filtered.map(s => {
    const isActive = s.id === currentSessionId;
    const shortId = s.id.slice(0, 8);
    const time = formatTime(s.createdAt);
    const inputPreview = truncate(stripPromptPrefix(s.input || ''), 60);
    const isLive = activeSessions.has(s.id);

    return `
      <div class="session-card ${isActive ? 'active' : ''}" data-id="${s.id}" onclick="selectSession('${s.id}')">
        <div class="session-card-top">
          <span class="session-card-id">${shortId}${isLive ? ' <span style="color:var(--green);font-size:9px">â— LIVE</span>' : ''}</span>
          <span class="session-card-time">${time}</span>
        </div>
        <div class="session-card-input">${escapeHtml(inputPreview)}</div>
        <div class="session-card-meta">
          <span class="badge badge-${s.status}">${s.status}</span>
          <span class="meta-item">${s.iterations || 0} iter</span>
          <span class="meta-item">$${(s.totalCostUsd || 0).toFixed(4)}</span>
          ${s.channelId ? `<span class="channel-tag ${channelColorClass(s.channelId)}">${escapeHtml(s.channelId.split(':')[0])}</span>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

$search.addEventListener('input', e => renderSessionList(e.target.value));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SESSION DETAIL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function selectSession(id) {
  currentSessionId = id;
  currentIteration = null;
  window.location.hash = id;
  renderSessionList($search.value);

  // Mobile: show detail view
  $layout.classList.add('detail-visible');

  $mainPanel.innerHTML = '<div class="loading" style="height:200px"><div class="loading-spinner"></div></div>';

  try {
    const [sessionData, traceData] = await Promise.all([
      fetchJSON(`/api/sessions/${id}`),
      fetchJSON(`/api/sessions/${id}/traces`),
    ]);
    currentTraces = traceData.traces;
    renderDetail(sessionData.session, traceData.traces);
  } catch (e) {
    $mainPanel.innerHTML = `<div class="empty-state"><div class="empty-state-text">Failed to load session: ${escapeHtml(e.message)}</div></div>`;
  }
}

function renderDetail(session, traces) {
  const iterations = getIterations(traces);
  const inputDisplay = stripPromptPrefix(session.input || '');

  const mobileBack = `<button class="mobile-back-btn" onclick="closeMobileDetail()">â† Back</button>`;

  $mainPanel.innerHTML = `
    ${mobileBack}
    <div class="detail">
      <div class="detail-header">
        <div class="detail-header-top">
          <div>
            <div class="detail-session-id">
              ${session.id}
              ${session.channelId ? `<span class="channel-tag ${channelColorClass(session.channelId)}">${escapeHtml(session.channelId.split(':')[0])}</span>` : ''}
              ${session.channelId && session.channelId.includes(':') ? `<span class="channel-tag" style="background:rgba(232,232,237,.08);color:var(--text-1)">user:${escapeHtml(session.channelId.split(':').slice(1).join(':'))}</span>` : ''}
              ${session.model ? `<span class="channel-tag ch-model">${escapeHtml(session.model)}</span>` : ''}
            </div>
            <div class="detail-input">${escapeHtml(truncate(inputDisplay, 200))}</div>
          </div>
          <span class="badge badge-${session.status}" style="flex-shrink:0">${session.status}</span>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-card"><div class="stat-label">Iterations</div><div class="stat-value">${session.iterations || 0}</div></div>
        <div class="stat-card"><div class="stat-label">Tokens</div><div class="stat-value">${formatNumber(session.totalTokens || 0)}</div></div>
        <div class="stat-card"><div class="stat-label">Prompt</div><div class="stat-value">${formatNumber(session.promptTokens || 0)}</div></div>
        <div class="stat-card"><div class="stat-label">Completion</div><div class="stat-value">${formatNumber(session.completionTokens || 0)}</div></div>
        <div class="stat-card"><div class="stat-label">Cost</div><div class="stat-value accent">$${(session.totalCostUsd || 0).toFixed(4)}</div></div>
      </div>

      ${iterations.length > 1 ? `
      <div class="iteration-nav">
        <span class="iteration-nav-label">Iteration</span>
        <div class="iter-dot iter-all ${currentIteration === null ? 'active' : ''}" onclick="filterIteration(null)">ALL</div>
        ${iterations.map(i => `<div class="iter-dot ${currentIteration === i ? 'active' : ''}" onclick="filterIteration(${i})">${i}</div>`).join('')}
      </div>` : ''}

      <div class="trace-timeline" id="trace-timeline">${renderTraces(traces)}</div>

      ${session.output ? `
      <div class="output-block">
        <div class="output-label">Final Output</div>
        <div class="output-text">${escapeHtml(session.output)}</div>
      </div>` : ''}
    </div>
  `;
}

function closeMobileDetail() {
  $layout.classList.remove('detail-visible');
}

function filterIteration(iter) {
  currentIteration = iter;
  const session = sessions.find(s => s.id === currentSessionId);
  if (session) renderDetail(session, currentTraces);
}

function renderTraces(traces) {
  const filtered = currentIteration !== null
    ? traces.filter(t => t.iteration === currentIteration)
    : traces;

  if (filtered.length === 0) {
    return '<div class="empty-state-text" style="padding:20px 0">No trace events for this iteration.</div>';
  }

  return filtered.map((t, i) => {
    const body = renderTraceBody(t);
    const tokens = renderTokenBadge(t);
    const delay = Math.min(i * 25, 280);
    return `
      <div class="trace-event" data-phase="${t.phase}" style="animation-delay:${delay}ms">
        <div class="trace-event-dot"></div>
        <div class="trace-event-card">
          <div class="trace-event-header">
            <span class="trace-phase">${formatPhase(t.phase)}</span>
            <span class="trace-iter">iter ${t.iteration}</span>
            ${tokens}
            <span class="trace-time">${formatTimestamp(t.timestamp)}</span>
          </div>
          ${body ? `<div class="trace-body">${body}</div>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function renderTraceBody(t) {
  if (!t.data) return '';
  const d = t.data;
  switch (t.phase) {
    case 'session_start':
      return escapeHtml(truncate(stripPromptPrefix(d.input || ''), 300));
    case 'reason': {
      const text = d.text || '';
      const tools = d.toolCallCount || 0;
      let out = escapeHtml(truncate(text, 500));
      if (tools > 0) out += `\n<span style="color:var(--violet)">${tools} tool call${tools > 1 ? 's' : ''} requested</span>`;
      return out;
    }
    case 'tool_call':
      return `<span class="tool-name">${escapeHtml(d.toolName || '')}</span>\n${escapeHtml(JSON.stringify(d.args || {}, null, 2))}`;
    case 'tool_result': {
      const hasError = d.error;
      const dur = d.durationMs != null ? ` <span class="tool-duration">(${d.durationMs}ms)</span>` : '';
      const label = hasError ? `<span class="tool-result-err">ERROR</span>` : `<span class="tool-result-ok">OK</span>`;
      const content = hasError ? (d.error || '') : (d.result || '');
      return `<span class="tool-name">${escapeHtml(d.toolName || '')}</span> ${label}${dur}\n${escapeHtml(truncate(String(content), 500))}`;
    }
    case 'finish':
      return escapeHtml(truncate(d.output || d.summary || '', 400));
    case 'error':
      return `<span style="color:var(--red)">${escapeHtml(d.error || 'Unknown error')}</span>`;
    case 'compaction':
      return `Tokens before: ${d.promptTokensBefore || '?'}\nSummary length: ${d.summaryLength || '?'} chars`;
    case 'observe':
      return `Processed ${d.toolResultCount || 0} tool result${(d.toolResultCount || 0) !== 1 ? 's' : ''}`;
    default:
      return escapeHtml(JSON.stringify(d, null, 2));
  }
}

function renderTokenBadge(t) {
  if (!t.promptTokens && !t.completionTokens) return '';
  return `<span class="trace-tokens"><span class="tok-in">${formatNumber(t.promptTokens || 0)}in</span><span class="tok-out">${formatNumber(t.completionTokens || 0)}out</span></span>`;
}

// Append a single live trace event to the currently-open session detail
function appendLiveTraceEvent(event) {
  const timeline = document.getElementById('trace-timeline');
  if (!timeline) return;
  const fake = {
    phase: event.phase,
    iteration: event.iteration,
    data: event.data,
    promptTokens: event.promptTokens,
    completionTokens: event.completionTokens,
    timestamp: event.ts,
  };
  const html = `
    <div class="trace-event" data-phase="${event.phase}" style="animation-delay:0ms">
      <div class="trace-event-dot"></div>
      <div class="trace-event-card">
        <div class="trace-event-header">
          <span class="trace-phase">${formatPhase(event.phase)}</span>
          <span class="trace-iter">iter ${event.iteration}</span>
          ${renderTokenBadge(fake)}
          <span class="trace-time">${formatTimestamp(event.ts)}</span>
        </div>
        ${renderTraceBody(fake) ? `<div class="trace-body">${renderTraceBody(fake)}</div>` : ''}
      </div>
    </div>
  `;
  timeline.insertAdjacentHTML('beforeend', html);
  // Scroll the main panel to see new events
  $mainPanel.scrollTop = $mainPanel.scrollHeight;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LIVE STREAM (UI-2)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initLiveStream() {
  if (liveEventSource) { liveEventSource.close(); }

  liveEventSource = new EventSource('/api/live');

  liveEventSource.addEventListener('ping', () => {
    setLiveDot('connected');
    $liveStatus.textContent = 'Connected';
  });

  liveEventSource.addEventListener('session_started', (e) => {
    const event = JSON.parse(e.data);
    activeSessions.add(event.sessionId);
    setLiveDot('active');
    pushLiveEvent({ ...event, type: 'session_started' });
    loadSessions(); // refresh sidebar
  });

  liveEventSource.addEventListener('trace_event', (e) => {
    const event = JSON.parse(e.data);
    pushLiveEvent({ ...event, type: 'trace_event' });
    // If the current session detail is this session, append the trace event live
    if (currentSessionId === event.sessionId && currentTab === 'traces') {
      appendLiveTraceEvent(event);
      currentTraces.push({
        phase: event.phase,
        iteration: event.iteration,
        data: event.data,
        promptTokens: event.promptTokens,
        completionTokens: event.completionTokens,
        timestamp: event.ts,
      });
    }
  });

  liveEventSource.addEventListener('session_completed', (e) => {
    const event = JSON.parse(e.data);
    activeSessions.delete(event.sessionId);
    if (activeSessions.size === 0) setLiveDot('connected');
    pushLiveEvent({ ...event, type: 'session_completed' });
    loadSessions(); // refresh sidebar to pick up final stats
    // Reload session detail if we're viewing this session
    if (currentSessionId === event.sessionId) {
      setTimeout(() => selectSession(event.sessionId), 500);
    }
  });

  liveEventSource.onerror = () => {
    setLiveDot('disconnected');
    $liveStatus.textContent = 'Disconnected â€” retryingâ€¦';
  };
}

function setLiveDot(state) {
  $liveDot.className = 'live-dot';
  $liveDot.title = state === 'connected' ? 'Live stream connected' : state === 'active' ? 'Session running' : 'Disconnected';
  if (state === 'connected') $liveDot.classList.add('connected');
  else if (state === 'active') $liveDot.classList.add('active');
}

function pushLiveEvent(event) {
  liveEvents.push(event);
  if (liveEvents.length > MAX_LIVE_EVENTS) liveEvents.shift();

  if (currentTab === 'live') renderLiveFeed();
}

function renderLiveFeed() {
  if (liveEvents.length === 0) {
    $liveFeed.innerHTML = `
      <div class="live-empty">
        <div class="live-empty-pulse"></div>
        <div class="empty-state-text">Waiting for session activityâ€¦</div>
      </div>`;
    return;
  }

  // Render most recent first (reversed)
  $liveFeed.innerHTML = [...liveEvents].reverse().map(ev => {
    const time = formatTimestamp(ev.ts);
    const shortId = (ev.sessionId || '').slice(0, 8);

    let msg = '';
    let phaseClass = '';

    switch (ev.type) {
      case 'session_started':
        msg = `â–¶ Session started: ${escapeHtml(truncate(stripPromptPrefix(ev.input || ''), 80))}`;
        phaseClass = 'phase-session_start';
        break;
      case 'trace_event':
        phaseClass = `phase-${ev.phase}`;
        msg = formatLiveTraceMsg(ev);
        break;
      case 'session_completed':
        msg = `â–  Session ${ev.status}`;
        phaseClass = 'phase-session_completed';
        break;
    }

    return `
      <div class="live-event">
        <span class="live-event-time">${time}</span>
        <div class="live-event-body">
          <div class="live-event-session">
            <span class="session-link" onclick="goToSessionTrace('${ev.sessionId}')">${shortId}</span>
            ${ev.channelId ? ` <span class="channel-tag ${channelColorClass(ev.channelId)}">${escapeHtml(ev.channelId.split(':')[0])}</span>` : ''}
          </div>
          <div class="live-event-msg ${phaseClass}">${msg}</div>
        </div>
      </div>
    `;
  }).join('');
}

function formatLiveTraceMsg(ev) {
  const d = ev.data || {};
  switch (ev.phase) {
    case 'session_start': return `â–¶ ${escapeHtml(truncate(stripPromptPrefix(d.input || ''), 80))}`;
    case 'reason': return `ğŸ’­ ${escapeHtml(truncate(d.text || '', 100))}`;
    case 'tool_call': return `âš¡ ${escapeHtml(d.toolName || 'tool')} called`;
    case 'tool_result': return `${d.error ? 'âœ—' : 'âœ“'} ${escapeHtml(d.toolName || 'tool')} ${d.error ? 'errored' : `returned (${d.durationMs ?? '?'}ms)`}`;
    case 'finish': return `â–  ${escapeHtml(truncate(d.output || d.summary || '', 100))}`;
    case 'error': return `âœ— ${escapeHtml(d.error || 'error')}`;
    case 'compaction': return `âŸ³ Compacted context`;
    case 'governance': return `ğŸ”’ ${escapeHtml(JSON.stringify(d).slice(0, 60))}`;
    default: return escapeHtml(formatPhase(ev.phase));
  }
}

function clearLiveFeed() {
  liveEvents = [];
  renderLiveFeed();
}

function goToSessionTrace(sessionId) {
  switchTab('traces');
  selectSession(sessionId);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MEMORY (UI-3)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMemory() {
  $memoryGrid.innerHTML = '<div class="loading" style="grid-column:1/-1"><div class="loading-spinner"></div></div>';
  try {
    const data = await fetchJSON('/api/memory');
    renderMemory(data.files);
    memoryLoaded = true;
  } catch (e) {
    $memoryGrid.innerHTML = `<div class="empty-state-text" style="padding:20px;grid-column:1/-1">Failed to load memory files: ${escapeHtml(e.message)}</div>`;
  }
}

function renderMemory(files) {
  $memoryGrid.innerHTML = files.map(f => {
    const contentHtml = f.content
      ? `<div class="memory-card-content">${escapeHtml(f.content)}</div>`
      : `<div class="memory-card-content memory-card-empty">(empty)</div>`;

    return `
      <div class="memory-card" id="memcard-${f.name}">
        <div class="memory-card-header">
          <span class="memory-card-name">${escapeHtml(f.name)}</span>
          <span class="memory-card-desc">${escapeHtml(f.description)}</span>
          <div class="memory-card-actions">
            <button class="mem-btn primary" onclick="startEdit('${f.name}', ${JSON.stringify(f.content).replace(/'/g, "\\'")})" title="Edit file">Edit</button>
          </div>
        </div>
        ${contentHtml}
        <div class="memory-card-editor" id="memeditor-${f.name}" style="display:none">
          <textarea class="mem-textarea" id="memta-${f.name}" spellcheck="false"></textarea>
          <div class="mem-editor-actions">
            <span class="mem-status hidden" id="memstatus-${f.name}">Saved</span>
            <button class="mem-btn" onclick="cancelEdit('${f.name}')">Cancel</button>
            <button class="mem-btn primary" onclick="saveMemory('${f.name}')">Save</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function startEdit(fileName, content) {
  const editor = document.getElementById(`memeditor-${fileName}`);
  const ta = document.getElementById(`memta-${fileName}`);
  if (!editor || !ta) return;
  ta.value = content;
  editor.style.display = 'flex';
  ta.focus();
}

function cancelEdit(fileName) {
  const editor = document.getElementById(`memeditor-${fileName}`);
  if (editor) editor.style.display = 'none';
}

async function saveMemory(fileName) {
  const ta = document.getElementById(`memta-${fileName}`);
  const statusEl = document.getElementById(`memstatus-${fileName}`);
  if (!ta) return;

  try {
    const res = await fetch(`/api/memory/${encodeURIComponent(fileName)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: ta.value }),
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({ error: res.statusText }));
      alert(`Save failed: ${err.error || res.statusText}`);
      return;
    }
    // Update the content display
    const card = document.getElementById(`memcard-${fileName}`);
    if (card) {
      const contentEl = card.querySelector('.memory-card-content');
      if (contentEl) contentEl.textContent = ta.value;
    }
    cancelEdit(fileName);
    if (statusEl) {
      statusEl.classList.remove('hidden');
      setTimeout(() => statusEl.classList.add('hidden'), 2000);
    }
  } catch (e) {
    alert(`Save failed: ${e.message}`);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COSTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCosts() {
  $costsPanel.innerHTML = '<div class="loading" style="height:200px"><div class="loading-spinner"></div></div>';
  try {
    costsData = await fetchJSON('/api/costs');
    renderCosts(costsData);
  } catch (e) {
    $costsPanel.innerHTML = `<div class="empty-state"><div class="empty-state-text">Failed to load cost data: ${escapeHtml(e.message)}</div></div>`;
  }
}

function renderCosts(data) {
  const { totals, daily, byChannel, byModel, byStatus, topSessions } = data;
  const avgCost = totals.sessions > 0 ? totals.cost / totals.sessions : 0;
  const statusColors = { completed: 'green', failed: 'red', timeout: 'orange', cost_limit: 'orange', running: 'blue', pending: 'violet' };
  const channelColors = ['accent','blue','cyan','violet','orange','green'];
  const modelColors = ['cyan','violet','blue','accent','orange','green'];
  const maxDaily = Math.max(...daily.map(d => d.cost), 0.0001);
  const maxChannelCost = Math.max(...byChannel.map(c => c.cost), 0.0001);
  const maxModelCost = Math.max(...byModel.map(m => m.cost), 0.0001);
  const maxStatusCost = Math.max(...byStatus.map(s => s.cost), 0.0001);

  $costsPanel.innerHTML = `
    <div class="costs-content">
      <div class="costs-stats-row">
        <div class="stat-card"><div class="stat-label">Total Cost</div><div class="stat-value accent">$${totals.cost.toFixed(4)}</div></div>
        <div class="stat-card"><div class="stat-label">Sessions</div><div class="stat-value">${totals.sessions}</div></div>
        <div class="stat-card"><div class="stat-label">Total Tokens</div><div class="stat-value">${formatNumber(totals.tokens)}</div></div>
        <div class="stat-card"><div class="stat-label">Avg / Session</div><div class="stat-value accent">$${avgCost.toFixed(4)}</div></div>
      </div>

      <div class="costs-section">
        <div class="costs-section-title">Daily Cost (Last 30 Days)</div>
        ${daily.length > 0 ? `
        <div class="daily-chart">
          ${daily.map(d => {
            const pct = (d.cost / maxDaily) * 100;
            return `<div class="daily-bar-wrap">
              <div class="daily-bar" style="height:${Math.max(pct,1)}%">
                <div class="daily-bar-tooltip">${d.date}<br>$${d.cost.toFixed(4)} Â· ${formatNumber(d.tokens)} tok Â· ${d.sessions} sess</div>
              </div>
              <span class="daily-bar-date">${d.date.slice(5)}</span>
            </div>`;
          }).join('')}
        </div>` : '<div class="empty-state-text">No data in the last 30 days.</div>'}
      </div>

      <div class="costs-grid">
        <div class="costs-section">
          <div class="costs-section-title">Cost by Channel</div>
          ${byChannel.map((ch, i) => {
            const pct = (ch.cost / maxChannelCost) * 100;
            const color = channelColors[i % channelColors.length];
            const label = ch.channel.includes(':') ? ch.channel.split(':')[0] : ch.channel;
            return `<div class="h-bar-row">
              <span class="h-bar-label">${escapeHtml(label)}</span>
              <div class="h-bar-track"><div class="h-bar-fill ${color}" style="width:${Math.max(pct,2)}%">$${ch.cost.toFixed(4)}</div></div>
              <span class="h-bar-value">${ch.sessions} sess</span>
            </div>`;
          }).join('')}
          ${byChannel.length === 0 ? '<div class="empty-state-text">No channel data.</div>' : ''}
        </div>
        <div class="costs-section">
          <div class="costs-section-title">Cost by Model</div>
          ${byModel.map((m, i) => {
            const pct = (m.cost / maxModelCost) * 100;
            const color = modelColors[i % modelColors.length];
            return `<div class="h-bar-row">
              <span class="h-bar-label">${escapeHtml(m.model)}</span>
              <div class="h-bar-track"><div class="h-bar-fill ${color}" style="width:${Math.max(pct,2)}%">$${m.cost.toFixed(4)}</div></div>
              <span class="h-bar-value">${m.sessions} sess</span>
            </div>`;
          }).join('')}
          ${byModel.length === 0 ? '<div class="empty-state-text">No model data.</div>' : ''}
        </div>
        <div class="costs-section">
          <div class="costs-section-title">Cost by Status</div>
          ${byStatus.map(s => {
            const pct = (s.cost / maxStatusCost) * 100;
            const color = statusColors[s.status] || 'accent';
            return `<div class="h-bar-row">
              <span class="h-bar-label">${escapeHtml(s.status)}</span>
              <div class="h-bar-track"><div class="h-bar-fill ${color}" style="width:${Math.max(pct,2)}%">$${s.cost.toFixed(4)}</div></div>
              <span class="h-bar-value">${s.sessions} sess</span>
            </div>`;
          }).join('')}
          ${byStatus.length === 0 ? '<div class="empty-state-text">No status data.</div>' : ''}
        </div>
      </div>

      <div class="costs-section">
        <div class="costs-section-title">Top 10 Most Expensive Sessions</div>
        ${topSessions.length > 0 ? `
        <table class="top-table">
          <thead><tr>
            <th>Session</th><th>Channel</th><th>Input</th><th>Cost</th><th>Tokens</th><th>Status</th><th>Date</th>
          </tr></thead>
          <tbody>
            ${topSessions.map(s => `<tr>
              <td><span class="link" onclick="goToSession('${s.id}')">${s.id.slice(0,8)}</span></td>
              <td>${s.channelId ? `<span class="channel-tag ${channelColorClass(s.channelId)}">${escapeHtml(s.channelId.split(':')[0])}</span>` : '<span style="color:var(--text-2)">â€”</span>'}</td>
              <td>${escapeHtml(truncate(stripPromptPrefix(s.input || ''), 50))}</td>
              <td style="color:var(--accent)">$${(s.cost||0).toFixed(4)}</td>
              <td>${formatNumber(s.tokens||0)}</td>
              <td><span class="badge badge-${s.status}">${s.status}</span></td>
              <td>${formatTime(s.createdAt)}</td>
            </tr>`).join('')}
          </tbody>
        </table>` : '<div class="empty-state-text">No sessions yet.</div>'}
      </div>
    </div>
  `;
}

function goToSession(id) {
  switchTab('traces');
  selectSession(id);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TAB SWITCHING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Plugin tab activators â€” populated by injected plugin JS
const _pluginTabActivated = {};

function switchTab(tab) {
  currentTab = tab;

  // Update button states
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });

  // Update layout class
  $layout.className = `layout tab-${tab}`;

  // Lazy-load built-in tab data
  if (tab === 'costs' && !costsData) loadCosts();
  if (tab === 'memory' && !memoryLoaded) loadMemory();
  if (tab === 'live') renderLiveFeed();

  // Plugin tab lazy-load (one-shot activators)
  if (_pluginTabActivated[tab] === false && typeof window['_pluginActivate_' + tab] === 'function') {
    window['_pluginActivate_' + tab]();
    _pluginTabActivated[tab] = true;
  }

  // Close mobile menu
  document.getElementById('tab-nav').classList.remove('open');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MOBILE MENU
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleMenu() {
  document.getElementById('tab-nav').classList.toggle('open');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// KEYBOARD NAV
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.key === 'j' || e.key === 'ArrowDown') { e.preventDefault(); navigateSession(1); }
  else if (e.key === 'k' || e.key === 'ArrowUp') { e.preventDefault(); navigateSession(-1); }
  else if (e.key === 'Escape') {
    currentSessionId = null;
    window.location.hash = '';
    $layout.classList.remove('detail-visible');
    renderSessionList($search.value);
    $mainPanel.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&rang;</div><div class="empty-state-text">Select a session to replay its trace.</div></div>';
  }
  else if (e.key === '/') { e.preventDefault(); $search.focus(); }
  else if (e.key === '1') switchTab('traces');
  else if (e.key === '2') switchTab('live');
  else if (e.key === '3') switchTab('memory');
  else if (e.key === '4') switchTab('costs');
  // __PLUGIN_KEYBOARD_SHORTCUTS__
});

function navigateSession(dir) {
  const idx = sessions.findIndex(s => s.id === currentSessionId);
  const next = idx + dir;
  if (next >= 0 && next < sessions.length) selectSession(sessions[next].id);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getIterations(traces) {
  const set = new Set(traces.map(t => t.iteration));
  return [...set].sort((a, b) => a - b);
}

function formatPhase(phase) { return phase.replace(/_/g, ' '); }

function formatTime(iso) {
  if (!iso) return '';
  const d = new Date(iso), now = new Date(), diff = now - d;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
  if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function formatTimestamp(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function formatNumber(n) {
  if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n/1000).toFixed(1) + 'k';
  return String(n);
}

function truncate(s, len) { return s.length > len ? s.slice(0, len) + 'â€¦' : s; }

function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = String(s);
  return div.innerHTML;
}

function channelColorClass(channelId) {
  const ch = (channelId || '').split(':')[0].toLowerCase();
  if (ch === 'telegram') return 'ch-telegram';
  if (ch === 'discord') return 'ch-discord';
  if (ch === 'slack') return 'ch-slack';
  if (ch === 'http' || ch === 'webhook') return 'ch-http';
  return '';
}

function stripPromptPrefix(input) {
  if (input.startsWith('You are running a scheduled heartbeat')) {
    const lines = input.split('\n');
    const dashes = lines.findIndex(l => l.trim() === '---');
    if (dashes > -1 && lines[dashes + 2]) return lines.slice(dashes + 2).join('\n').trim();
    return '[Heartbeat Check]';
  }
  if (input.startsWith('You are processing an incoming webhook')) {
    const lines = input.split('\n');
    const eventLine = lines.find(l => l.startsWith('**Event:**'));
    const event = eventLine ? eventLine.replace('**Event:** ', '') : 'unknown';
    return `[Webhook: ${event}]`;
  }
  return input;
}

// __PLUGIN_JS__

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BOOT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
