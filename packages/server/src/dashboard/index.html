<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>baseAgent — Trace Replay</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap');

/* ─── DESIGN TOKENS ─── */
:root {
  --bg-0: #0a0a0b;
  --bg-1: #111113;
  --bg-2: #19191d;
  --bg-3: #222228;
  --border: #2a2a32;
  --border-active: #3a3a45;
  --text-0: #e8e8ed;
  --text-1: #a0a0b0;
  --text-2: #666680;
  --accent: #e0ff4f;
  --accent-dim: rgba(224, 255, 79, 0.12);
  --accent-glow: rgba(224, 255, 79, 0.06);
  --red: #ff4f6a;
  --orange: #ff9f43;
  --cyan: #4ff0e0;
  --blue: #4f8fff;
  --violet: #a06fff;
  --green: #4fff8f;
  --font-mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
  --font-sans: 'DM Sans', system-ui, -apple-system, sans-serif;
  --radius: 6px;
  --ease: cubic-bezier(0.16, 1, 0.3, 1);
}

/* ─── RESET ─── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 14px; -webkit-font-smoothing: antialiased; }

body {
  font-family: var(--font-sans);
  background: var(--bg-0);
  color: var(--text-0);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ─── GRAIN OVERLAY ─── */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  z-index: 9999;
  pointer-events: none;
  opacity: 0.025;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size: 128px;
}

/* ─── LAYOUT SHELL ─── */
.shell {
  display: grid;
  grid-template-columns: 340px 1fr;
  grid-template-rows: 56px 1fr;
  height: 100vh;
  overflow: hidden;
}

/* ─── TOP BAR ─── */
.topbar {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 0 20px;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border);
  z-index: 10;
}

.topbar-brand {
  display: flex;
  align-items: center;
  gap: 10px;
  font-family: var(--font-mono);
  font-weight: 600;
  font-size: 13px;
  letter-spacing: 0.04em;
  color: var(--text-0);
}

.topbar-brand .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 8px var(--accent);
  animation: pulse 2.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.topbar-sep {
  width: 1px;
  height: 24px;
  background: var(--border);
}

.topbar-label {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 400;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--text-2);
}

.topbar-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 12px;
}

.topbar-stat {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-2);
}

.topbar-stat strong {
  color: var(--text-1);
  font-weight: 500;
}

/* ─── SIDEBAR (SESSION LIST) ─── */
.sidebar {
  background: var(--bg-1);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--bg-3) transparent;
}

.sidebar-header {
  position: sticky;
  top: 0;
  z-index: 5;
  padding: 14px 16px 10px;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border);
}

.sidebar-title {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-2);
  margin-bottom: 10px;
}

.sidebar-search {
  width: 100%;
  padding: 7px 10px;
  font-family: var(--font-mono);
  font-size: 12px;
  background: var(--bg-2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-0);
  outline: none;
  transition: border-color 0.2s;
}

.sidebar-search::placeholder { color: var(--text-2); }
.sidebar-search:focus { border-color: var(--accent); }

.session-list {
  padding: 6px 8px;
}

.session-card {
  padding: 10px 12px;
  margin-bottom: 2px;
  border-radius: var(--radius);
  cursor: pointer;
  border: 1px solid transparent;
  transition: all 0.15s var(--ease);
  position: relative;
}

.session-card:hover {
  background: var(--bg-2);
  border-color: var(--border);
}

.session-card.active {
  background: var(--accent-dim);
  border-color: var(--accent);
}

.session-card.active .session-card-id { color: var(--accent); }

.session-card-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 5px;
}

.session-card-id {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 500;
  color: var(--text-1);
  letter-spacing: 0.02em;
}

.session-card-time {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-2);
}

.session-card-input {
  font-size: 12px;
  color: var(--text-1);
  line-height: 1.4;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
  max-width: 100%;
  margin-bottom: 6px;
}

.session-card-meta {
  display: flex;
  align-items: center;
  gap: 10px;
}

.badge {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 0.04em;
  padding: 2px 6px;
  border-radius: 3px;
  text-transform: uppercase;
}

.badge-completed { background: rgba(79, 255, 143, 0.1); color: var(--green); }
.badge-failed { background: rgba(255, 79, 106, 0.1); color: var(--red); }
.badge-running { background: rgba(79, 143, 255, 0.1); color: var(--blue); animation: pulse 1.5s infinite; }
.badge-timeout { background: rgba(255, 159, 67, 0.1); color: var(--orange); }
.badge-cost_limit { background: rgba(255, 159, 67, 0.1); color: var(--orange); }
.badge-pending { background: rgba(160, 160, 176, 0.1); color: var(--text-2); }

.meta-item {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-2);
}

/* ─── MAIN CONTENT ─── */
.main {
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--bg-3) transparent;
}

/* ─── EMPTY STATE ─── */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  gap: 16px;
  color: var(--text-2);
}

.empty-state-icon {
  width: 48px;
  height: 48px;
  border: 2px solid var(--border);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

.empty-state-text {
  font-family: var(--font-mono);
  font-size: 12px;
  text-align: center;
  line-height: 1.6;
}

/* ─── SESSION DETAIL ─── */
.detail {
  padding: 24px 28px;
  max-width: 960px;
  animation: fadeUp 0.3s var(--ease);
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ─── DETAIL HEADER ─── */
.detail-header {
  margin-bottom: 24px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--border);
}

.detail-header-top {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 12px;
}

.detail-session-id {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-2);
  letter-spacing: 0.02em;
}

.detail-input {
  font-size: 16px;
  font-weight: 500;
  line-height: 1.5;
  color: var(--text-0);
  margin: 8px 0 0;
  word-break: break-word;
}

/* ─── STATS ROW ─── */
.stats-row {
  display: flex;
  gap: 2px;
  margin-bottom: 24px;
}

.stat-card {
  flex: 1;
  padding: 12px 14px;
  background: var(--bg-1);
  border: 1px solid var(--border);
}

.stat-card:first-child { border-radius: var(--radius) 0 0 var(--radius); }
.stat-card:last-child { border-radius: 0 var(--radius) var(--radius) 0; }

.stat-label {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-2);
  margin-bottom: 4px;
}

.stat-value {
  font-family: var(--font-mono);
  font-size: 18px;
  font-weight: 600;
  color: var(--text-0);
}

.stat-value.accent { color: var(--accent); }

/* ─── ITERATION NAVIGATOR ─── */
.iteration-nav {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
}

.iteration-nav-label {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-2);
  margin-right: 4px;
}

.iter-dot {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 600;
  background: var(--bg-2);
  border: 1px solid var(--border);
  color: var(--text-2);
  cursor: pointer;
  transition: all 0.15s var(--ease);
  flex-shrink: 0;
}

.iter-dot:hover {
  background: var(--bg-3);
  border-color: var(--border-active);
  color: var(--text-1);
}

.iter-dot.active {
  background: var(--accent);
  border-color: var(--accent);
  color: var(--bg-0);
  box-shadow: 0 0 12px var(--accent-dim);
}

.iter-dot.iter-all {
  width: auto;
  border-radius: 16px;
  padding: 0 12px;
  font-size: 10px;
  letter-spacing: 0.06em;
}

/* ─── TRACE TIMELINE ─── */
.trace-timeline {
  position: relative;
}

.trace-timeline::before {
  content: '';
  position: absolute;
  left: 15px;
  top: 0;
  bottom: 0;
  width: 1px;
  background: linear-gradient(to bottom, var(--border), transparent);
}

/* ─── TRACE EVENT ─── */
.trace-event {
  position: relative;
  padding-left: 44px;
  padding-bottom: 4px;
  animation: fadeUp 0.25s var(--ease) both;
}

.trace-event-dot {
  position: absolute;
  left: 8px;
  top: 4px;
  width: 15px;
  height: 15px;
  border-radius: 50%;
  border: 2px solid var(--border);
  background: var(--bg-0);
  z-index: 2;
}

.trace-event[data-phase="session_start"] .trace-event-dot { border-color: var(--accent); background: var(--accent); }
.trace-event[data-phase="reason"] .trace-event-dot { border-color: var(--blue); background: var(--blue); }
.trace-event[data-phase="tool_call"] .trace-event-dot { border-color: var(--violet); background: var(--violet); }
.trace-event[data-phase="tool_result"] .trace-event-dot { border-color: var(--cyan); background: var(--cyan); }
.trace-event[data-phase="finish"] .trace-event-dot { border-color: var(--green); background: var(--green); }
.trace-event[data-phase="error"] .trace-event-dot { border-color: var(--red); background: var(--red); }
.trace-event[data-phase="governance"] .trace-event-dot { border-color: var(--orange); background: var(--orange); }
.trace-event[data-phase="compaction"] .trace-event-dot { border-color: var(--text-2); background: var(--text-2); }
.trace-event[data-phase="observe"] .trace-event-dot { border-color: var(--text-2); }
.trace-event[data-phase="model_fallback"] .trace-event-dot { border-color: var(--orange); background: var(--orange); }

.trace-event-card {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 14px;
  margin-bottom: 8px;
  transition: border-color 0.15s;
}

.trace-event-card:hover {
  border-color: var(--border-active);
}

.trace-event-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.trace-phase {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.04em;
}

.trace-event[data-phase="session_start"] .trace-phase { color: var(--accent); }
.trace-event[data-phase="reason"] .trace-phase { color: var(--blue); }
.trace-event[data-phase="tool_call"] .trace-phase { color: var(--violet); }
.trace-event[data-phase="tool_result"] .trace-phase { color: var(--cyan); }
.trace-event[data-phase="finish"] .trace-phase { color: var(--green); }
.trace-event[data-phase="error"] .trace-phase { color: var(--red); }
.trace-event[data-phase="governance"] .trace-phase { color: var(--orange); }
.trace-event[data-phase="compaction"] .trace-phase { color: var(--text-2); }
.trace-event[data-phase="observe"] .trace-phase { color: var(--text-2); }
.trace-event[data-phase="model_fallback"] .trace-phase { color: var(--orange); }

.trace-iter {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-2);
  padding: 1px 5px;
  background: var(--bg-2);
  border-radius: 3px;
}

.trace-time {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-2);
  margin-left: auto;
}

.trace-tokens {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-2);
  display: flex;
  gap: 6px;
}

.trace-tokens .tok-in { color: var(--blue); }
.trace-tokens .tok-out { color: var(--cyan); }

.trace-body {
  font-family: var(--font-mono);
  font-size: 12px;
  line-height: 1.6;
  color: var(--text-1);
  white-space: pre-wrap;
  word-break: break-word;
  max-height: 280px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--bg-3) transparent;
}

.trace-body-toggle {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--accent);
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px 0;
  opacity: 0.8;
}

.trace-body-toggle:hover { opacity: 1; }

/* Tool-specific styling */
.tool-name {
  font-weight: 600;
  color: var(--violet);
}

.tool-result-ok { color: var(--cyan); }
.tool-result-err { color: var(--red); }
.tool-duration {
  font-size: 10px;
  color: var(--text-2);
}

/* ─── OUTPUT BLOCK ─── */
.output-block {
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}

.output-label {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-2);
  margin-bottom: 10px;
}

.output-text {
  font-family: var(--font-mono);
  font-size: 12px;
  line-height: 1.7;
  color: var(--text-0);
  padding: 16px;
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  white-space: pre-wrap;
  word-break: break-word;
}

/* ─── LOADING ─── */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px;
}

.loading-spinner {
  width: 20px;
  height: 20px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* ─── CHANNEL TAG ─── */
.channel-tag {
  font-family: var(--font-mono);
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 3px;
  background: var(--bg-3);
  color: var(--text-2);
}

/* ─── RESPONSIVE ─── */
@media (max-width: 768px) {
  .shell {
    grid-template-columns: 1fr;
    grid-template-rows: 56px auto 1fr;
  }
  .sidebar {
    border-right: none;
    border-bottom: 1px solid var(--border);
    max-height: 35vh;
  }
  .stats-row { flex-wrap: wrap; }
  .stat-card { min-width: calc(50% - 2px); }
  .stat-card:first-child, .stat-card:last-child { border-radius: var(--radius); }
}
</style>
</head>
<body>

<div class="shell">
  <!-- TOP BAR -->
  <header class="topbar">
    <div class="topbar-brand">
      <span class="dot"></span>
      baseAgent
    </div>
    <div class="topbar-sep"></div>
    <span class="topbar-label">Trace Replay</span>
    <div class="topbar-right">
      <span class="topbar-stat" id="stat-sessions">Sessions: <strong>--</strong></span>
      <span class="topbar-stat" id="stat-uptime">Uptime: <strong>--</strong></span>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">Sessions</div>
      <input type="text" class="sidebar-search" placeholder="Filter sessions..." id="session-search">
    </div>
    <div class="session-list" id="session-list">
      <div class="loading"><div class="loading-spinner"></div></div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main" id="main">
    <div class="empty-state">
      <div class="empty-state-icon">&rang;</div>
      <div class="empty-state-text">
        Select a session to replay its trace.<br>
        <span style="color:var(--text-2)">Sessions load from the agent database.</span>
      </div>
    </div>
  </main>
</div>

<script>
// ─── STATE ───
let sessions = [];
let currentSessionId = null;
let currentTraces = [];
let currentIteration = null; // null = show all

const $list = document.getElementById('session-list');
const $main = document.getElementById('main');
const $search = document.getElementById('session-search');
const $statSessions = document.getElementById('stat-sessions');
const $statUptime = document.getElementById('stat-uptime');

// ─── API ───
async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

// ─── INIT ───
async function init() {
  await loadSessions();
  loadHealth();
  setInterval(loadHealth, 30000);

  // Check URL hash for deep link
  const hash = window.location.hash.slice(1);
  if (hash) selectSession(hash);
}

async function loadSessions() {
  try {
    const data = await fetchJSON('/api/sessions?limit=100');
    sessions = data.sessions;
    $statSessions.innerHTML = `Sessions: <strong>${sessions.length}</strong>`;
    renderSessionList();
  } catch (e) {
    $list.innerHTML = '<div class="empty-state-text" style="padding:20px">Failed to load sessions</div>';
  }
}

async function loadHealth() {
  try {
    const data = await fetchJSON('/health');
    const secs = data.uptime;
    const h = Math.floor(secs / 3600);
    const m = Math.floor((secs % 3600) / 60);
    $statUptime.innerHTML = `Uptime: <strong>${h}h ${m}m</strong>`;
  } catch {}
}

// ─── RENDER SESSION LIST ───
function renderSessionList(filter = '') {
  const filtered = filter
    ? sessions.filter(s =>
        s.id.includes(filter) ||
        (s.input || '').toLowerCase().includes(filter.toLowerCase()) ||
        (s.channelId || '').toLowerCase().includes(filter.toLowerCase()) ||
        (s.status || '').toLowerCase().includes(filter.toLowerCase())
      )
    : sessions;

  if (filtered.length === 0) {
    $list.innerHTML = '<div class="empty-state-text" style="padding:20px">No sessions found</div>';
    return;
  }

  $list.innerHTML = filtered.map(s => {
    const isActive = s.id === currentSessionId;
    const shortId = s.id.slice(0, 8);
    const time = formatTime(s.createdAt);
    const inputPreview = truncate(stripPromptPrefix(s.input || ''), 60);
    const statusClass = `badge-${s.status}`;

    return `
      <div class="session-card ${isActive ? 'active' : ''}" data-id="${s.id}" onclick="selectSession('${s.id}')">
        <div class="session-card-top">
          <span class="session-card-id">${shortId}</span>
          <span class="session-card-time">${time}</span>
        </div>
        <div class="session-card-input">${escapeHtml(inputPreview)}</div>
        <div class="session-card-meta">
          <span class="badge ${statusClass}">${s.status}</span>
          <span class="meta-item">${s.iterations || 0} iter</span>
          <span class="meta-item">$${(s.totalCostUsd || 0).toFixed(4)}</span>
          ${s.channelId ? `<span class="channel-tag">${escapeHtml(s.channelId.split(':')[0])}</span>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

$search.addEventListener('input', (e) => renderSessionList(e.target.value));

// ─── SELECT SESSION ───
async function selectSession(id) {
  currentSessionId = id;
  currentIteration = null;
  window.location.hash = id;
  renderSessionList($search.value);

  $main.innerHTML = '<div class="loading" style="height:200px"><div class="loading-spinner"></div></div>';

  try {
    const [sessionData, traceData] = await Promise.all([
      fetchJSON(`/api/sessions/${id}`),
      fetchJSON(`/api/sessions/${id}/traces`),
    ]);

    currentTraces = traceData.traces;
    renderDetail(sessionData.session, traceData.traces);
  } catch (e) {
    $main.innerHTML = `<div class="empty-state"><div class="empty-state-text">Failed to load session: ${escapeHtml(e.message)}</div></div>`;
  }
}

// ─── RENDER SESSION DETAIL ───
function renderDetail(session, traces) {
  const shortId = session.id.slice(0, 8);
  const iterations = getIterations(traces);
  const inputDisplay = stripPromptPrefix(session.input || '');

  $main.innerHTML = `
    <div class="detail">
      <div class="detail-header">
        <div class="detail-header-top">
          <div>
            <div class="detail-session-id">${session.id}</div>
            <div class="detail-input">${escapeHtml(truncate(inputDisplay, 200))}</div>
          </div>
          <span class="badge badge-${session.status}" style="flex-shrink:0">${session.status}</span>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-label">Iterations</div>
          <div class="stat-value">${session.iterations || 0}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Tokens</div>
          <div class="stat-value">${formatNumber(session.totalTokens || 0)}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Prompt</div>
          <div class="stat-value">${formatNumber(session.promptTokens || 0)}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Completion</div>
          <div class="stat-value">${formatNumber(session.completionTokens || 0)}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Cost</div>
          <div class="stat-value accent">$${(session.totalCostUsd || 0).toFixed(4)}</div>
        </div>
      </div>

      ${iterations.length > 1 ? `
      <div class="iteration-nav">
        <span class="iteration-nav-label">Iteration</span>
        <div class="iter-dot iter-all ${currentIteration === null ? 'active' : ''}" onclick="filterIteration(null)">ALL</div>
        ${iterations.map(i => `
          <div class="iter-dot ${currentIteration === i ? 'active' : ''}" onclick="filterIteration(${i})">${i}</div>
        `).join('')}
      </div>
      ` : ''}

      <div class="trace-timeline" id="trace-timeline">
        ${renderTraces(traces)}
      </div>

      ${session.output ? `
      <div class="output-block">
        <div class="output-label">Final Output</div>
        <div class="output-text">${escapeHtml(session.output)}</div>
      </div>
      ` : ''}
    </div>
  `;
}

function filterIteration(iter) {
  currentIteration = iter;
  // Re-render just the timeline and nav
  const session = sessions.find(s => s.id === currentSessionId);
  if (session) renderDetail(session, currentTraces);
}

// ─── RENDER TRACES ───
function renderTraces(traces) {
  const filtered = currentIteration !== null
    ? traces.filter(t => t.iteration === currentIteration)
    : traces;

  if (filtered.length === 0) {
    return '<div class="empty-state-text" style="padding:20px 0">No trace events for this iteration.</div>';
  }

  return filtered.map((t, i) => {
    const body = renderTraceBody(t);
    const tokens = renderTokenBadge(t);
    const delay = Math.min(i * 30, 300);

    return `
      <div class="trace-event" data-phase="${t.phase}" style="animation-delay:${delay}ms">
        <div class="trace-event-dot"></div>
        <div class="trace-event-card">
          <div class="trace-event-header">
            <span class="trace-phase">${formatPhase(t.phase)}</span>
            <span class="trace-iter">iter ${t.iteration}</span>
            ${tokens}
            <span class="trace-time">${formatTimestamp(t.timestamp)}</span>
          </div>
          ${body ? `<div class="trace-body">${body}</div>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function renderTraceBody(t) {
  if (!t.data) return '';
  const d = t.data;

  switch (t.phase) {
    case 'session_start':
      return escapeHtml(truncate(stripPromptPrefix(d.input || ''), 300));

    case 'reason': {
      const text = d.text || '';
      const tools = d.toolCallCount || 0;
      let out = escapeHtml(truncate(text, 500));
      if (tools > 0) out += `\n<span style="color:var(--violet)">${tools} tool call${tools > 1 ? 's' : ''} requested</span>`;
      return out;
    }

    case 'tool_call':
      return `<span class="tool-name">${escapeHtml(d.toolName || '')}</span>\n${escapeHtml(JSON.stringify(d.args || {}, null, 2))}`;

    case 'tool_result': {
      const hasError = d.error;
      const dur = d.durationMs != null ? ` <span class="tool-duration">(${d.durationMs}ms)</span>` : '';
      const label = hasError
        ? `<span class="tool-result-err">ERROR</span>`
        : `<span class="tool-result-ok">OK</span>`;
      const content = hasError ? (d.error || '') : (d.result || '');
      return `<span class="tool-name">${escapeHtml(d.toolName || '')}</span> ${label}${dur}\n${escapeHtml(truncate(String(content), 500))}`;
    }

    case 'finish':
      return escapeHtml(truncate(d.output || d.summary || '', 400));

    case 'error':
      return `<span style="color:var(--red)">${escapeHtml(d.error || 'Unknown error')}</span>`;

    case 'compaction':
      return `Tokens before: ${d.promptTokensBefore || '?'}\nSummary length: ${d.summaryLength || '?'} chars`;

    case 'observe':
      return `Processed ${d.toolResultCount || 0} tool result${(d.toolResultCount || 0) !== 1 ? 's' : ''}`;

    case 'governance':
      return escapeHtml(JSON.stringify(d, null, 2));

    case 'model_fallback':
      return escapeHtml(JSON.stringify(d, null, 2));

    default:
      return escapeHtml(JSON.stringify(d, null, 2));
  }
}

function renderTokenBadge(t) {
  if (!t.promptTokens && !t.completionTokens) return '';
  return `<span class="trace-tokens"><span class="tok-in">${formatNumber(t.promptTokens || 0)}in</span><span class="tok-out">${formatNumber(t.completionTokens || 0)}out</span></span>`;
}

// ─── HELPERS ───
function getIterations(traces) {
  const set = new Set(traces.map(t => t.iteration));
  return [...set].sort((a, b) => a - b);
}

function formatPhase(phase) {
  return phase.replace(/_/g, ' ');
}

function formatTime(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  const now = new Date();
  const diff = now - d;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
  if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function formatTimestamp(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function formatNumber(n) {
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
  return String(n);
}

function truncate(s, len) {
  return s.length > len ? s.slice(0, len) + '...' : s;
}

function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

function stripPromptPrefix(input) {
  // Strip common prompt prefixes from heartbeat/webhook system prompts
  if (input.startsWith('You are running a scheduled heartbeat')) {
    const lines = input.split('\n');
    const dashes = lines.findIndex(l => l.trim() === '---');
    if (dashes > -1 && lines[dashes + 2]) return lines.slice(dashes + 2).join('\n').trim();
    return '[Heartbeat Check]';
  }
  if (input.startsWith('You are processing an incoming webhook')) {
    const lines = input.split('\n');
    const eventLine = lines.find(l => l.startsWith('**Event:**'));
    const event = eventLine ? eventLine.replace('**Event:** ', '') : 'unknown';
    return `[Webhook: ${event}]`;
  }
  return input;
}

// ─── KEYBOARD NAV ───
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT') return;

  if (e.key === 'j' || e.key === 'ArrowDown') {
    e.preventDefault();
    navigateSession(1);
  } else if (e.key === 'k' || e.key === 'ArrowUp') {
    e.preventDefault();
    navigateSession(-1);
  } else if (e.key === 'Escape') {
    currentSessionId = null;
    window.location.hash = '';
    renderSessionList($search.value);
    $main.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&rang;</div><div class="empty-state-text">Select a session to replay its trace.</div></div>';
  } else if (e.key === '/') {
    e.preventDefault();
    $search.focus();
  }
});

function navigateSession(dir) {
  const idx = sessions.findIndex(s => s.id === currentSessionId);
  const next = idx + dir;
  if (next >= 0 && next < sessions.length) {
    selectSession(sessions[next].id);
  }
}

// ─── BOOT ───
init();
</script>
</body>
</html>
